<?php

/**
 * @file
 * Contains vppn.module.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function vppn_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the vppn module.
    case 'help.page.vppn':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('View Permissions Per Node') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_form_alter().
 */
function vppn_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Make sure it's a valid type.
  if (!\Drupal::service('vppn.handler')->checkIfContentTypeEnabled()) {
    // Not a VPPN form.
    return;
  }
  $form['vppn'] = array(
    '#type' => 'details',
    '#title' => t('View access'),
    '#group' => 'advanced',
    '#open' => FALSE,
    'markup' => array(
      '#markup' => '<p>Random Markup</p>',
    ),
  );
  $form['vppn']['description']= array(
    '#prefix' => '<div class="form-item">',
    '#suffix' => '</div>',
    '#markup' => t('Select which roles can view this node.  Select none for default.'),
  );
  // Get the default roles.
  $default_roles = \Drupal::service('vppn.handler')->getDefaultsForNode($form);
  $default_roles = $default_roles ? $default_roles : array();
  // Role checkboxes.
  $form['vppn']['vppn_roles'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Select roles'),
    '#title_display' => 'invisible',
    '#options' => array(),
    '#default_value' => $default_roles,
  );
  // Get all user roles.
  $user_roles = user_roles(TRUE);
  // Get users that can bypass access control (skip anon - that would be weird).
  $user_roles_bypass = user_roles(TRUE, 'bypass node access');
  // Remove the users that can bypass access control.
  $user_roles = array_diff_key($user_roles, $user_roles_bypass);
  // Each non-bypass role.
  foreach ($user_roles as $role_id => $role_obj) {
    $form['vppn']['vppn_roles']['#options'][$role_id] = $role_obj->label();
  }
  // Add submission handler.
  $form['actions']['submit']['#submit'][] = 'vppn_node_form_submit';
}

function vppn_node_form_submit($form, \Drupal\Core\Form\FormStateInterface $form_state){
  $vals = $form_state->getValues();
  if(isset($vals['vppn_roles'])){
    $roles = $vals['vppn_roles'];
    if($roles){
      foreach($roles as $roleName => $value){
        \Drupal::service('vppn.handler')->cleanEntriesByEntityId($form_state->getFormObject()->getEntity()->id());
        \Drupal::service('vppn.handler')->insertRoleEntry($roleName,$value);
      }
    }
  }
}

/**
 * Implements hook_node_access().
 */
function vppn_node_access(\Drupal\node\NodeInterface $node, $op, \Drupal\Core\Session\AccountInterface $account) {

  // Only concerned with viewing.
  if ($op != 'view') {

    // Ignore if any other op.
    return AccessResult::neutral();
  }

  // Make sure there's a node id.
  if (empty($node->nid)) {

    // Should never happen but ignore if no nid.
    return AccessResult::neutral();
  }


  $configEnabled = \Drupal::config('vppn.vppnconfig')->get('vppn_node_list');

  // Check if it's a valid VPPN content type.
  if (empty($node->getType()) || !in_array($node->getType(),$configEnabled,TRUE)) {

    // Not a VPPN node type, we don't care.
    return AccessResult::neutral();
  }

  // Get the records for this node.
  $records = \Drupal::database()->select('vppn')
    ->fields('vppn', array('rid'))
    ->condition('nid', $node->id())
    ->execute();

  // Check that there is a record for this node.
  if (!$records->rowCount()) {

    // No record.
    return AccessResult::neutral();
  }

  // Get the roles that can view this node.
  $allowed_roles = array_flip($records->fetchCol());

  // Make sure the user has one of the allowed roles.
  return count(array_intersect_key($allowed_roles, $account->roles)) ?

    // User has access, great success.
    AccessResult::allowed() :

    // Permissions defined and not enabled, deny.
    AccessResult::forbidden();
}


